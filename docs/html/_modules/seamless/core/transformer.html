
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>seamless.core.transformer &#8212; seamless 0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for seamless.core.transformer</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">deque</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>

<span class="kn">from</span> <span class="nn">.macro</span> <span class="k">import</span> <span class="n">macro</span>
<span class="kn">from</span> <span class="nn">.worker</span> <span class="k">import</span> <span class="n">Worker</span><span class="p">,</span> <span class="n">InputPin</span><span class="p">,</span> <span class="n">OutputPin</span>
<span class="kn">from</span> <span class="nn">.cell</span> <span class="k">import</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">PythonCell</span>
<span class="kn">from</span> <span class="nn">.pythreadkernel</span> <span class="k">import</span> <span class="n">Transformer</span> <span class="k">as</span> <span class="n">KernelTransformer</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">IpyString</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">dtypes</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">silk</span>

<span class="n">transformer_param_docson</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;pin&quot;</span><span class="p">:</span> <span class="s2">&quot;Required. Can be </span><span class="se">\&quot;</span><span class="s2">input</span><span class="se">\&quot;</span><span class="s2"> or </span><span class="se">\&quot;</span><span class="s2">output</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
  <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="s2">&quot;Optional, must be registered with types if defined&quot;</span>
<span class="p">}</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">currdir = os.path.dirname(__file__)</span>
<span class="sd">silk.register(</span>
<span class="sd">  open(os.path.join(currdir, &quot;transformer.silk&quot;)).read(),</span>
<span class="sd">  doc = &quot;Transformer pin parameters&quot;,</span>
<span class="sd">  docson = transformer_param_docson  #(&quot;json&quot;, &quot;docson&quot;)</span>
<span class="sd">)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">transformer_params</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="s2">&quot;silk.SeamlessTransformerPin&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">dtypes</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
  <span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;seamless&quot;</span><span class="p">,</span> <span class="s2">&quot;transformer_params&quot;</span><span class="p">),</span>
  <span class="n">typeschema</span> <span class="o">=</span> <span class="n">transformer_params</span><span class="p">,</span> <span class="c1">#(&quot;json&quot;, &quot;typeschema&quot;)</span>
  <span class="n">docson</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="s2">&quot;Transformer pin parameters&quot;</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;Transformer parameters&quot;</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">Transformer</span><span class="p">(</span><span class="n">Worker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the main-thread part of the transformer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_required_code_type</span> <span class="o">=</span> <span class="n">PythonCell</span><span class="o">.</span><span class="n">CodeTypes</span><span class="o">.</span><span class="n">FUNCTION</span>
    <span class="n">transformer</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">transformer_thread</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">output_thread</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transformer_params</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">.context</span> <span class="k">import</span> <span class="n">get_active_context</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">InputPin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="s2">&quot;python&quot;</span><span class="p">))</span>
        <span class="n">thread_inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;code&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connected_output</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_value_preliminary</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">_registrars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transformer_params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">transformer_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">transformer_params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transformer_params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
            <span class="n">pin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span>
                <span class="n">pin</span> <span class="o">=</span> <span class="n">InputPin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                <span class="n">thread_inputs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span>
            <span class="k">elif</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
                <span class="n">pin</span> <span class="o">=</span> <span class="n">OutputPin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_name</span> <span class="ow">is</span> <span class="kc">None</span>  <span class="c1"># can have only one output</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_output_name</span> <span class="o">=</span> <span class="n">p</span>
            <span class="k">elif</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;registrar&quot;</span><span class="p">:</span>
                <span class="n">registrar_name</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;registrar&quot;</span><span class="p">]</span>
                <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_active_context</span><span class="p">()</span>
                <span class="n">manager</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">_manager</span>
                <span class="n">registrar</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ctx</span><span class="o">.</span><span class="n">registrar</span><span class="p">,</span> <span class="n">registrar_name</span><span class="p">)</span>
                <span class="n">_registrars</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">registrar</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;pin&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">pin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_io_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span>

        <span class="sd">&quot;&quot;&quot;Output listener thread</span>
<span class="sd">        - It must have the same memory space as the main thread</span>
<span class="sd">        - It must run async from the main thread</span>
<span class="sd">        =&gt; This will always be a thread, regardless of implementation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_finish</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_semaphore</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;Transformer thread</span>
<span class="sd">        For now, it is implemented as a thread</span>
<span class="sd">         However, it could as well be implemented as process</span>
<span class="sd">        - It shares no memory space with the main thread</span>
<span class="sd">          (other than the deques and semaphores, which could as well be</span>
<span class="sd">           implemented using network sockets)</span>
<span class="sd">        - It must run async from the main thread</span>
<span class="sd">        TODO: in case of process, synchronize registrars (use execnet?)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">KernelTransformer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">thread_inputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_queue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_semaphore</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="c1">#to update the transformer registrars</span>

        <span class="k">for</span> <span class="n">registrar</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_registrars</span><span class="p">:</span>
            <span class="n">registrar</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">.macro</span> <span class="k">import</span> <span class="n">add_activate</span>
        <span class="n">add_activate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;Seamless transformer: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_path</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toplevel</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_successor</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">listen_output</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#TODO: name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_thread</span> <span class="o">=</span> <span class="n">thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#TODO: name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer_thread</span> <span class="o">=</span> <span class="n">thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">transformer_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transformer_params</span>

    <span class="k">def</span> <span class="nf">set_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">Worker</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">receive_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_pin</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_updates</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_message_id</span><span class="p">,</span> <span class="n">input_pin</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">input_queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">semaphore</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">receive_registrar_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">registrar_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">namespace_name</span><span class="p">):</span>
        <span class="c1">#TODO: this will only work for same-namespace (thread) kernels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message_id</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_updates</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">registrar_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">namespace_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">input_queue</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_message_id</span><span class="p">,</span> <span class="s2">&quot;@REGISTRAR&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">semaphore</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">listen_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO logging</span>
        <span class="c1"># TODO requires_function cleanup</span>

        <span class="c1"># This code is very convoluted... networking expert wanted for cleanup!</span>

        <span class="k">def</span> <span class="nf">get_item</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_semaphore</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_finish</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_queue</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="n">output_name</span><span class="p">,</span> <span class="n">output_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">output_name</span><span class="p">,</span> <span class="n">output_value</span>

        <span class="k">def</span> <span class="nf">receive_end</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">updates_on_hold</span>
            <span class="k">if</span> <span class="n">updates_on_hold</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span> <span class="c1">#100x5 ms</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_semaphore</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">blocking</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output_semaphore</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="k">break</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.005</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pending_updates</span> <span class="o">-=</span> <span class="n">updates_on_hold</span>
                    <span class="n">updates_on_hold</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">updates_on_hold</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">updates_on_hold</span><span class="p">:</span>
                    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Difficult situation. At the one hand, we can&#39;t hold on to</span>
<span class="sd">                    these processed updates forever:</span>
<span class="sd">                     It would keep the transformer marked as unstable, blocking</span>
<span class="sd">                      equilibrate().</span>
<span class="sd">                    On the other hand, an output_value could be just waiting</span>
<span class="sd">                    for us. If we decrement _pending_updates too early, this may</span>
<span class="sd">                    unblock equilibrate() while equilibrium has not been reached</span>
<span class="sd">                    The solution is that the kernel must respond within 500 ms</span>
<span class="sd">                    with an @START signal, and then a @END signal when the</span>
<span class="sd">                    computation is complete</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span> <span class="c1">#100x5 ms</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_semaphore</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">blocking</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output_semaphore</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                            <span class="k">break</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.005</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_updates</span> <span class="o">-=</span> <span class="n">updates_on_hold</span>
                        <span class="n">updates_on_hold</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">item</span> <span class="o">=</span> <span class="n">get_item</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">output_name</span><span class="p">,</span> <span class="n">output_value</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">if</span> <span class="n">output_name</span> <span class="o">==</span> <span class="s2">&quot;@START&quot;</span><span class="p">:</span>
                    <span class="n">between_start_end</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">get_item</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">output_name</span><span class="p">,</span> <span class="n">output_value</span> <span class="o">=</span> <span class="n">item</span>
                    <span class="k">assert</span> <span class="n">output_name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;@PRELIMINARY&quot;</span><span class="p">,</span> <span class="s2">&quot;@END&quot;</span><span class="p">),</span> <span class="n">output_name</span>
                    <span class="k">if</span> <span class="n">output_name</span> <span class="o">==</span> <span class="s2">&quot;@END&quot;</span><span class="p">:</span>
                        <span class="n">between_start_end</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">receive_end</span><span class="p">()</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="n">get_item</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">output_name</span><span class="p">,</span> <span class="n">output_value</span> <span class="o">=</span> <span class="n">item</span>

                <span class="k">if</span> <span class="n">output_name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">updates_processed</span> <span class="o">=</span> <span class="n">output_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_updates</span> <span class="o">&lt;</span> <span class="n">updates_processed</span><span class="p">:</span>
                        <span class="c1">#This will not set the worker as stable</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_updates</span> <span class="o">-=</span> <span class="n">updates_processed</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># hold on to updates_processed for a while, we don&#39;t</span>
                        <span class="c1">#  want to set the worker as stable before we have</span>
                        <span class="c1">#  done a send_update</span>
                        <span class="n">updates_on_hold</span> <span class="o">+=</span> <span class="n">updates_processed</span>
                    <span class="k">continue</span>

                <span class="n">preliminary</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">output_name</span> <span class="o">==</span> <span class="s2">&quot;@PRELIMINARY&quot;</span><span class="p">:</span>
                    <span class="n">preliminary</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">output_name</span><span class="p">,</span> <span class="n">output_value</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">between_start_end</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">output_name</span> <span class="o">==</span> <span class="s2">&quot;@END&quot;</span><span class="p">,</span> <span class="n">output_name</span>
                    <span class="n">between_start_end</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">receive_end</span><span class="p">()</span>
                    <span class="k">continue</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">get_item</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">output_name</span><span class="p">,</span> <span class="n">output_value</span> <span class="o">=</span> <span class="n">item</span>

                <span class="k">assert</span> <span class="n">output_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_name</span><span class="p">,</span> <span class="n">item</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connected_output</span><span class="p">:</span>
                    <span class="n">pin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_name</span><span class="p">]</span>
                    <span class="c1">#use .partial, we&#39;re not in the main thread!</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">pin</span><span class="o">.</span><span class="n">send_update</span><span class="p">,</span> <span class="n">output_value</span><span class="p">,</span>
                        <span class="n">preliminary</span><span class="o">=</span><span class="n">preliminary</span><span class="p">)</span>
                    <span class="kn">import</span> <span class="nn">seamless</span>
                    <span class="n">seamless</span><span class="o">.</span><span class="n">add_work</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_last_value</span> <span class="o">=</span> <span class="n">output_value</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_last_value_preliminary</span> <span class="o">=</span> <span class="n">preliminary</span>

                <span class="k">if</span> <span class="n">preliminary</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">item</span> <span class="o">=</span> <span class="n">get_item</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">output_name</span><span class="p">,</span> <span class="n">output_value</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">assert</span> <span class="n">output_name</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="n">updates_processed</span> <span class="o">=</span> <span class="n">output_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pending_updates</span> <span class="o">-=</span> <span class="n">updates_processed</span>

                <span class="k">if</span> <span class="n">updates_on_hold</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pending_updates</span> <span class="o">-=</span> <span class="n">updates_on_hold</span>
                    <span class="n">updates_on_hold</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span> <span class="c1">#TODO: store it?</span>

    <span class="k">def</span> <span class="nf">_on_connect_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">last_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_value</span>
        <span class="k">if</span> <span class="n">last_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">preliminary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_value_preliminary</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_value_preliminary</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_output_name</span><span class="p">]</span><span class="o">.</span><span class="n">send_update</span><span class="p">(</span><span class="n">last_value</span><span class="p">,</span>
                <span class="n">preliminary</span><span class="o">=</span><span class="n">preliminary</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connected_output</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_on_disconnect_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_destroyed</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connected_output</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_destroyed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># gracefully terminate the transformer thread</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">finish</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">semaphore</span><span class="o">.</span><span class="n">release</span><span class="p">()</span> <span class="c1"># to unblock the .finish event</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformer_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer_thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformer_thread</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># gracefully terminate the output thread</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_thread</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_finish</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_semaphore</span><span class="o">.</span><span class="n">release</span><span class="p">()</span> <span class="c1"># to unblock for the output_finish</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_thread</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_thread</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># free all input and output pins</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_attrs</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">value</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_set_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">force_detach</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_set_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">force_detach</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">registrars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">registrar</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">registrars</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a text representation of any exception (with traceback)</span>
<span class="sd">        that occurred during transformer execution&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">exception</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">IpyString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">exception</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The computation status of the transformer</span>
<span class="sd">        Returns a dictionary containing the status of all pins that are not OK.</span>
<span class="sd">        If all pins are OK, returns the status of the transformer itself: OK or pending</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pinname</span><span class="p">,</span> <span class="n">pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">pin</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">StatusFlags</span><span class="o">.</span><span class="n">OK</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">pinname</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span>
        <span class="k">for</span> <span class="n">pinname</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">_pending_inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pinname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">pinname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">StatusFlags</span><span class="o">.</span><span class="n">PENDING</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">_pending_updates</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">StatusFlags</span><span class="o">.</span><span class="n">PENDING</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">StatusFlags</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">StatusFlags</span><span class="o">.</span><span class="n">OK</span><span class="o">.</span><span class="n">name</span>

<span class="c1"># @macro takes nothing, a type, or a dict of types</span>
<div class="viewcode-block" id="transformer"><a class="viewcode-back" href="../../../coreapi.html#seamless.transformer">[docs]</a><span class="nd">@macro</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;seamless&quot;</span><span class="p">,</span> <span class="s2">&quot;transformer_params&quot;</span><span class="p">),</span> <span class="n">with_context</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">transformer</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines a transformer worker.</span>

<span class="sd">Transformers transform their input cells into an output result.</span>
<span class="sd">Transformers are connected to their input cells via input pins, and their</span>
<span class="sd">result is connected to an output cell via an output pin. There can be only one</span>
<span class="sd">output pin. The pins are declared in the `params` parameter (see below).</span>

<span class="sd">In addition, all transformers have an implicit input pin named &quot;code&quot;,</span>
<span class="sd">which must be connected to a Python cell ( `dtype=(&quot;text&quot;, &quot;code&quot;, &quot;python&quot;)` ).</span>
<span class="sd">The code must be a Python block that returns the result using a &quot;return&quot; statement.</span>
<span class="sd">All input values are injected directly into the code&#39;s namespace. The variable</span>
<span class="sd">name of the input is the same as its pin name.</span>

<span class="sd">As of seamless 0.1, all transformers are asynchronous (non-blocking),</span>
<span class="sd">and they carry out their computation in a separate process</span>
<span class="sd">(using ``multiprocessing``).</span>

<span class="sd">As of seamless 0.1, transformers start their computation as soon as all inputs</span>
<span class="sd">(including the code) has been defined, even if no output cell has been connected.</span>
<span class="sd">Whenever the input data or code changes, a new computation is performed. If the</span>
<span class="sd">previous computation is still in progress, it is canceled.</span>

<span class="sd">Inside the transformer code, preliminary values can be returned using</span>
<span class="sd">``return_preliminary(value)``.</span>
<span class="sd">As of seamless 0.1, this does not require any special pin declaration.</span>

<span class="sd">Invoke ``transformer.status()`` to get the current status of the transformer.</span>

<span class="sd">Invoke ``shell(transformer)`` to create an IPython shell</span>
<span class="sd">of the transformer namespace.</span>

<span class="sd">``pin.connect(cell)`` connects an outputpin to a cell.</span>

<span class="sd">``cell.connect(pin)`` connects a cell to an inputpin.</span>

<span class="sd">``pin.cell()`` returns or creates a cell that is connected to that pin.</span>

<span class="sd">Parameters</span>
<span class="sd">----------</span>

<span class="sd">    params: dict</span>
<span class="sd">        A dictionary containing the transformer parameters.</span>

<span class="sd">        As of seamless 0.1, each (name,value) item represents a transformer pin:</span>

<span class="sd">        -  name: string</span>
<span class="sd">            name of the pin</span>

<span class="sd">        -  value: dict</span>
<span class="sd">            with the following items:</span>

<span class="sd">            - pin: string</span>
<span class="sd">                must be &quot;input&quot; or &quot;output&quot;. Only one output pin is allowed.</span>
<span class="sd">            - dtype: string or tuple of strings</span>
<span class="sd">                Describes the dtype of the cell(s) connected to the pin.</span>
<span class="sd">                As of seamless 0.1, the following data types are understood:</span>

<span class="sd">                -   &quot;int&quot;, &quot;float&quot;, &quot;bool&quot;, &quot;str&quot;, &quot;json&quot;, &quot;cson&quot;, &quot;array&quot;, &quot;signal&quot;</span>
<span class="sd">                -   &quot;text&quot;, (&quot;text&quot;, &quot;code&quot;, &quot;python&quot;), (&quot;text&quot;, &quot;code&quot;, &quot;ipython&quot;)</span>
<span class="sd">                -   (&quot;text&quot;, &quot;code&quot;, &quot;silk&quot;), (&quot;text&quot;, &quot;code&quot;, &quot;slash-0&quot;)</span>
<span class="sd">                -   (&quot;text&quot;, &quot;code&quot;, &quot;vertexshader&quot;), (&quot;text&quot;, &quot;code&quot;, &quot;fragmentshader&quot;),</span>
<span class="sd">                -   (&quot;text&quot;, &quot;html&quot;),</span>
<span class="sd">                -   (&quot;json&quot;, &quot;seamless&quot;, &quot;transformer_params&quot;),</span>
<span class="sd">                    (&quot;cson&quot;, &quot;seamless&quot;, &quot;transformer_params&quot;),</span>
<span class="sd">                -   (&quot;json&quot;, &quot;seamless&quot;, &quot;reactor_params&quot;),</span>
<span class="sd">                    (&quot;cson&quot;, &quot;seamless&quot;, &quot;reactor_params&quot;)</span>

<span class="sd">        Since &quot;transformer&quot; is a macro, the dictionary can also be provided</span>
<span class="sd">        in the form of a cell of dtype (&quot;json&quot;, &quot;seamless&quot;, &quot;transformer_params&quot;)</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">seamless.core.transformer</span> <span class="k">import</span> <span class="n">Transformer</span> <span class="c1">#code must be standalone</span>
    <span class="k">return</span> <span class="n">Transformer</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></div>

<span class="kn">from</span> <span class="nn">.context</span> <span class="k">import</span> <span class="n">Context</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">seamless</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basic_example.html">Basic example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coreapi.html">Seamless core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library.html">Standard library</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../seamless.html">seamless</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016-2017, Sjoerd de Vries.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>