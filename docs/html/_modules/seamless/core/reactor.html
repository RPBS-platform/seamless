
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>seamless.core.reactor &#8212; seamless 0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for seamless.core.reactor</h1><div class="highlight"><pre>
<span></span><span class="c1">#totally synchronous, for GUI</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>

<span class="kn">from</span> <span class="nn">.macro</span> <span class="k">import</span> <span class="n">macro</span>
<span class="kn">from</span> <span class="nn">.worker</span> <span class="k">import</span> <span class="n">Worker</span><span class="p">,</span> <span class="n">InputPin</span><span class="p">,</span> <span class="n">EditPin</span><span class="p">,</span> <span class="n">OutputPin</span>
<span class="kn">from</span> <span class="nn">.cell</span> <span class="k">import</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">PythonCell</span>
<span class="kn">from</span> <span class="nn">.pysynckernel</span> <span class="k">import</span> <span class="n">Reactor</span> <span class="k">as</span> <span class="n">KernelReactor</span>
<span class="kn">from</span> <span class="nn">..dtypes.objects</span> <span class="k">import</span> <span class="n">PythonBlockObject</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">IpyString</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">dtypes</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">silk</span>
<span class="kn">import</span> <span class="nn">seamless</span>

<span class="c1">#TODO: on_disconnect? don&#39;t do anything if self._destroyed</span>

<span class="n">reactor_param_docson</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#TODO, adapt from transformer</span>
<span class="n">currdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">silk.register(</span>
<span class="sd">  open(os.path.join(currdir, &quot;reactor.silk&quot;)).read(),</span>
<span class="sd">  doc = &quot;Reactor pin parameters&quot;,</span>
<span class="sd">  docson = reactor_param_docson  #(&quot;json&quot;, &quot;docson&quot;)</span>
<span class="sd">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">reactor_params</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="s2">&quot;silk.ReactorPin&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">dtypes</span><span class="o">.</span><span class="n">register</span><span class="p">(</span>
  <span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;seamless&quot;</span><span class="p">,</span> <span class="s2">&quot;reactor_params&quot;</span><span class="p">),</span>
  <span class="n">typeschema</span> <span class="o">=</span> <span class="n">reactor_params</span><span class="p">,</span> <span class="c1">#(&quot;json&quot;, &quot;typeschema&quot;)</span>
  <span class="n">docson</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;*&quot;</span><span class="p">:</span> <span class="s2">&quot;Reactor pin parameters&quot;</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;Reactor parameters&quot;</span>
<span class="p">)</span>

<span class="k">class</span> <span class="nc">Reactor</span><span class="p">(</span><span class="n">Worker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is the main-thread part of the worker</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_required_code_type</span> <span class="o">=</span> <span class="n">PythonCell</span><span class="o">.</span><span class="n">CodeTypes</span><span class="o">.</span><span class="n">ANY</span>
    <span class="n">_shell_rae</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reactor_params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="kn">from</span> <span class="nn">.macro</span> <span class="k">import</span> <span class="n">get_macro_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_start</span> <span class="o">=</span> <span class="n">InputPin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;code_start&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="s2">&quot;python&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_update</span> <span class="o">=</span> <span class="n">InputPin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;code_update&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="s2">&quot;python&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_stop</span> <span class="o">=</span> <span class="n">InputPin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;code_stop&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span> <span class="s2">&quot;python&quot;</span><span class="p">))</span>
        <span class="n">kernel_inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_io_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;code_start&quot;</span><span class="p">,</span> <span class="s2">&quot;code_update&quot;</span><span class="p">,</span> <span class="s2">&quot;code_stop&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;code_start&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_start</span><span class="p">,</span>
                        <span class="s2">&quot;code_update&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_update</span><span class="p">,</span>
                        <span class="s2">&quot;code_stop&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_stop</span><span class="p">,</span>
                     <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reactor_params</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">reactor_params</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="s2">&quot;@shell&quot;</span><span class="p">:</span>
                <span class="n">rae</span> <span class="o">=</span> <span class="n">reactor_params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                <span class="n">rae</span> <span class="o">=</span> <span class="n">rae</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shell_rae</span> <span class="o">=</span> <span class="n">rae</span>
                <span class="k">continue</span>

            <span class="c1">#TODO: check that they don&#39;t overlap with reactor attributes (.path, .name, ...),</span>
            <span class="c1">#     ...and with code_start, code_update, code_stop, or is that allowed  (???)</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">reactor_params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reactor_params</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;input&quot;</span><span class="p">:</span>
                <span class="n">pin</span> <span class="o">=</span> <span class="n">InputPin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                <span class="n">kernel_inputs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">,</span> <span class="p">(</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s2">&quot;signal&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span>
                <span class="n">pin</span> <span class="o">=</span> <span class="n">OutputPin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span>
            <span class="k">elif</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;pin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;edit&quot;</span><span class="p">:</span>
                <span class="n">pin</span> <span class="o">=</span> <span class="n">EditPin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                <span class="n">kernel_inputs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;must_be_defined&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_io_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">pin</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="n">KernelReactor</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">kernel_inputs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">get_macro_mode</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">OutputPin</span><span class="p">):</span>
                    <span class="n">pin</span><span class="o">.</span><span class="n">cell</span><span class="p">()</span> <span class="c1">#auto-create a cell</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="s2">&quot;Seamless reactor: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_path</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_shell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">toplevel</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_successor</span><span class="p">()</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">namespace</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shell_rae</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shell_rae</span><span class="p">:</span>
                <span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">namespace</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reactor_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reactor_params</span>

    <span class="k">def</span> <span class="nf">output_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">send_update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">updates_processed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">updates</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_updates</span> <span class="o">-=</span> <span class="n">updates</span>

    <span class="k">def</span> <span class="nf">set_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">Worker</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">pin</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">receive_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_pin</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_updates</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="p">[</span><span class="n">input_pin</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;signal&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">process_input</span><span class="p">(</span><span class="n">input_pin</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">work</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">process_input</span><span class="p">,</span> <span class="n">input_pin</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">)</span>
            <span class="n">seamless</span><span class="o">.</span><span class="n">add_work</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">receive_registrar_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">registrar_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">namespace_name</span><span class="p">):</span>
        <span class="c1">#TODO: this will only work for same-namespace (thread) kernels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_updates</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">process_input</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">registrar_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">namespace_name</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;@REGISTRAR&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">seamless</span><span class="o">.</span><span class="n">add_work</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a text representation of any exception (with traceback)</span>
<span class="sd">        that occurred during reactor execution&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">traceback</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">exception</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">exception</span>
            <span class="n">tbstr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="n">exc</span><span class="p">,</span> <span class="n">tb</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">IpyString</span><span class="p">(</span><span class="n">tbstr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The computation status of the reactor</span>
<span class="sd">        Returns a dictionary containing the status of all pins that are not OK.</span>
<span class="sd">        If all pins are OK, returns the status of the reactor itself: OK or pending</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">pinname</span><span class="p">,</span> <span class="n">pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pins</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">pin</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">StatusFlags</span><span class="o">.</span><span class="n">OK</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">pinname</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span>
        <span class="k">for</span> <span class="n">pinname</span> <span class="ow">in</span> <span class="n">rc</span><span class="o">.</span><span class="n">_pending_inputs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pinname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">pinname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">StatusFlags</span><span class="o">.</span><span class="n">PENDING</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">if</span> <span class="n">rc</span><span class="o">.</span><span class="n">_pending_updates</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">StatusFlags</span><span class="o">.</span><span class="n">PENDING</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">StatusFlags</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">name</span>            
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">StatusFlags</span><span class="o">.</span><span class="n">OK</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_destroyed</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">reactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reactor</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

        <span class="c1"># free all input and output pins</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_io_attrs</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">value</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">pass</span>

<span class="c1"># @macro takes nothing, a type, or a dict of types</span>
<div class="viewcode-block" id="reactor"><a class="viewcode-back" href="../../../coreapi.html#seamless.reactor">[docs]</a><span class="nd">@macro</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="s2">&quot;seamless&quot;</span><span class="p">,</span> <span class="s2">&quot;reactor_params&quot;</span><span class="p">),</span><span class="n">with_context</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reactor</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines a reactor worker.</span>

<span class="sd">Reactors react upon changes in their input cells.</span>
<span class="sd">Reactors are connected to their input cells via inputpins. In addition, reactors</span>
<span class="sd">may manipulate output cells via outputpins. Finally, a cell may be both an</span>
<span class="sd">input and an output of the reactor, by connecting it via an editpin.</span>
<span class="sd">The pins are declared in the `params` parameter (see below).</span>

<span class="sd">In addition, all reactors have three implicit inputpins named `code_start`,</span>
<span class="sd">`code_update` and `code_stop`. Each pin must be connected to a Python cell</span>
<span class="sd">( `dtype=(&quot;text&quot;, &quot;code&quot;, &quot;python&quot;)` ), containing a code block.</span>

<span class="sd">The reactor will start as soon as all input cells (including the three code cells)</span>
<span class="sd">have been defined. The startup of the reactor will trigger the execution of the</span>
<span class="sd">code in the `code_start` cell.</span>

<span class="sd">Any change in the inputpins (including at startup)</span>
<span class="sd">will trigger the execution of the `code_update` cell. The `code_stop` cell is</span>
<span class="sd">invoked when the reactor is destroyed.</span>

<span class="sd">As of seamless 0.1, macro re-evaluation destroys and re-creates all reactors</span>
<span class="sd">created by the macro, unless the macro has caching enabled.</span>

<span class="sd">All three code cells are executed in the same namespace. The namespace contains</span>
<span class="sd">an object called `PINS`. This object can be queried for pin objects: a pin</span>
<span class="sd">called `spam` is accessible as pin object ``PINS.spam``. The namespace also</span>
<span class="sd">contains IDENTIFIER, which is guaranteed to be unique for each reactor</span>
<span class="sd">instance.</span>

<span class="sd">Every inputpin and editpin object contains a ``get()`` method that</span>
<span class="sd">returns the value.</span>
<span class="sd">As of seamless 0.1, the `value` property is identical to ``pin.get()``.</span>

<span class="sd">Every inputpin and editpin object has a property `updated`, which is True if</span>
<span class="sd">the pin has been updated since the last time `code_update` was executed.</span>

<span class="sd">Every outputpin and editpin has a ``set(value)`` method.</span>
<span class="sd">In case of a signal outputpin, ``set()`` is to be invoked without argument.</span>
<span class="sd">Invoking ``set()`` on a signal outputpin will propagate the signal as fast as possible:</span>
<span class="sd">    - If set from the main thread: immediately. Downstream workers are</span>
<span class="sd">      notified and activated (if synchronous) before set() returns</span>
<span class="sd">    - If set from another thread: as soon as ``seamless.run_work`` is called.</span>
<span class="sd">      Then, downstream workers are notified and activated before any other</span>
<span class="sd">      non-signal notification.</span>

<span class="sd">As of seamless 0.1, all reactors are synchronous (blocking): their code is</span>
<span class="sd">executed in the main thread. Therefore, seamless and IPython are non-responsive</span>
<span class="sd">while reactor code is executing, and reactor code should return as soon as</span>
<span class="sd">possible. Therefore, if they perform long computations, reactors should spawn</span>
<span class="sd">their own threads or processes from within their code.</span>

<span class="sd">Invoke ``reactor.status()`` to get the current status of the reactor</span>

<span class="sd">Invoke ``shell(reactor)`` to create an IPython shell of the reactor namespace</span>

<span class="sd">``pin.connect(cell)`` connects an outputpin to a cell</span>

<span class="sd">``cell.connect(pin)`` connects a cell to an inputpin</span>

<span class="sd">``pin.cell()`` returns or creates a cell that is connected to that pin</span>

<span class="sd">Parameters</span>
<span class="sd">----------</span>

<span class="sd">    params: dict</span>
<span class="sd">        A dictionary containing the reactor parameters.</span>
<span class="sd">        As of seamless 0.1, each (name,value) item represents a reactor pin:</span>

<span class="sd">        -  name: string</span>
<span class="sd">            name of the pin</span>

<span class="sd">        -  value: dict</span>
<span class="sd">            with the following items:</span>

<span class="sd">            - pin: string</span>
<span class="sd">                must be &quot;input&quot;, &quot;output&quot; or &quot;edit&quot;</span>
<span class="sd">            - dtype: string or tuple of strings</span>
<span class="sd">                Describes the dtype of the cell(s) connected to the pin.</span>
<span class="sd">                As of seamless 0.1, the following data types are understood:</span>

<span class="sd">                -   &quot;int&quot;, &quot;float&quot;, &quot;bool&quot;, &quot;str&quot;, &quot;json&quot;, &quot;cson&quot;, &quot;array&quot;, &quot;signal&quot;</span>
<span class="sd">                -   &quot;text&quot;, (&quot;text&quot;, &quot;code&quot;, &quot;python&quot;), (&quot;text&quot;, &quot;code&quot;, &quot;ipython&quot;)</span>
<span class="sd">                -   (&quot;text&quot;, &quot;code&quot;, &quot;silk&quot;), (&quot;text&quot;, &quot;code&quot;, &quot;slash-0&quot;)</span>
<span class="sd">                -   (&quot;text&quot;, &quot;code&quot;, &quot;vertexshader&quot;), (&quot;text&quot;, &quot;code&quot;, &quot;fragmentshader&quot;),</span>
<span class="sd">                -   (&quot;text&quot;, &quot;html&quot;),</span>
<span class="sd">                -   (&quot;json&quot;, &quot;seamless&quot;, &quot;transformer_params&quot;),</span>
<span class="sd">                    (&quot;cson&quot;, &quot;seamless&quot;, &quot;transformer_params&quot;),</span>
<span class="sd">                -   (&quot;json&quot;, &quot;seamless&quot;, &quot;reactor_params&quot;),</span>
<span class="sd">                    (&quot;cson&quot;, &quot;seamless&quot;, &quot;reactor_params&quot;)</span>

<span class="sd">            - must_be_defined: bool</span>
<span class="sd">               default = True</span>

<span class="sd">               In case of edit pins, if `must_be_defined` is False, the reactor</span>
<span class="sd">               will start up  even if the connected cell does not yet have a</span>
<span class="sd">               defined value.</span>

<span class="sd">        Since &quot;reactor&quot; is a macro, the dictionary can also be provided</span>
<span class="sd">        in the form of a cell of dtype (&quot;json&quot;, &quot;seamless&quot;, &quot;reactor_params&quot;)</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">seamless.core.reactor</span> <span class="k">import</span> <span class="n">Reactor</span> <span class="c1">#code must be standalone</span>
    <span class="k">return</span> <span class="n">Reactor</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></div>

<span class="kn">from</span> <span class="nn">.context</span> <span class="k">import</span> <span class="n">Context</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">seamless</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basic_example.html">Basic example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../coreapi.html">Seamless core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library.html">Standard library</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  <li><a href="../../seamless.html">seamless</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016-2017, Sjoerd de Vries.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>